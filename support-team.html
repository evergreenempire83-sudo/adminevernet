<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evernet Support</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ========== CSS VARIABLES ========== */
        :root {
            --navy: #001f3f;
            --navy-light: #003366;
            --white: #ffffff;
            --light: #f8f9fa;
            --gray: #6c757d;
            --border: #dee2e6;
            --online: #28a745;
            --offline: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* ========== MAIN CONTAINER ========== */
        .creator-portal {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        .portal-header {
            background: var(--navy);
            color: var(--white);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .portal-brand {
            font-size: 1.5em;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: var(--white);
            color: var(--navy);
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .back-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        /* ========== STATUS BAR ========== */
        .status-bar {
            background: var(--white);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--offline);
        }

        .status-dot.online {
            background: var(--online);
        }

        .status-text {
            font-weight: 500;
            font-size: 0.9em;
            color: var(--navy);
        }

        .gmt-time {
            font-size: 0.85em;
            color: var(--gray);
        }

        /* ========== MAIN CONTENT ========== */
        .portal-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ========== SIDEBAR ========== */
        .sidebar {
            width: 300px;
            background: var(--white);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 15px;
        }

        .new-ticket-btn {
            background: var(--navy);
            color: var(--white);
            border: none;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        .new-ticket-btn:hover {
            background: var(--navy-light);
            transform: translateY(-2px);
        }

        .tickets-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .ticket-item {
            padding: 15px;
            background: var(--white);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .ticket-item:hover {
            background: #f8f9fa;
            border-color: var(--navy);
        }

        .ticket-item.active {
            background: #e9f7fe;
            border-color: var(--navy);
        }

        .ticket-id {
            font-family: monospace;
            font-weight: 600;
            color: var(--navy);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .ticket-subject {
            font-weight: 500;
            font-size: 0.95em;
            margin-bottom: 8px;
            color: var(--navy);
        }

        .ticket-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: var(--gray);
        }

        .ticket-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .status-open {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .status-in-progress {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .status-resolved {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .status-closed {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .unread-badge {
            width: 8px;
            height: 8px;
            background: #dc3545;
            border-radius: 50%;
            margin-left: auto;
        }

        /* ========== CHAT AREA ========== */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--white);
            position: relative;
        }

        .chat-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 5px;
        }

        .chat-subtitle {
            font-size: 0.9em;
            color: var(--gray);
        }

        /* ========== NEW TICKET BUTTON IN CHAT HEADER ========== */
        .chat-header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .new-ticket-chat-btn {
            background: var(--navy);
            color: var(--white);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.3s;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .new-ticket-chat-btn:hover {
            background: var(--navy-light);
            transform: translateY(-2px);
        }

        .full-screen-chat .new-ticket-chat-btn {
            display: flex;
        }

        .back-to-tickets-btn {
            background: var(--white);
            color: var(--navy);
            border: 1px solid var(--navy);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.3s;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .back-to-tickets-btn:hover {
            background: #f8f9fa;
        }

        .full-screen-chat .back-to-tickets-btn {
            display: flex;
        }

        /* ========== CHAT MESSAGES ========== */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-break: break-word;
        }

        .message.creator {
            align-self: flex-end;
            background: var(--navy);
            color: var(--white);
        }

        .message.support {
            align-self: flex-start;
            background: var(--white);
            color: var(--navy);
            border: 1px solid var(--border);
        }

        .message.system {
            align-self: center;
            background: #ffc107;
            color: var(--white);
            max-width: 85%;
            text-align: center;
            font-size: 0.9em;
            padding: 10px 20px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85em;
            opacity: 0.9;
        }

        .message-content {
            line-height: 1.5;
            font-size: 0.95em;
        }

        .message-time {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 8px;
            text-align: right;
        }

        /* ========== CHAT INPUT ========== */
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--white);
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            resize: none;
            min-height: 60px;
            background: var(--white);
            color: var(--navy);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--navy);
        }

        .send-btn {
            background: var(--navy);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 14px 24px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 60px;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--navy-light);
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ========== CLOSED TICKET VIEW ========== */
        .closed-ticket-view {
            text-align: center;
            padding: 40px 20px;
            background: var(--white);
            border-top: 1px solid var(--border);
        }

        .closed-ticket-icon {
            font-size: 3em;
            color: var(--gray);
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .closed-ticket-message {
            color: var(--navy);
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        .closed-ticket-btn {
            background: var(--navy);
            color: var(--white);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1em;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .closed-ticket-btn:hover {
            background: var(--navy-light);
            transform: translateY(-2px);
        }

        /* ========== OFFLINE AUTO-RESPONSE NOTICE ========== */
        .auto-response-notice {
            background: #fff8e1;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 0 20px 20px 20px;
            font-size: 0.9em;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ========== MODALS ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--navy);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            color: var(--gray);
        }

        .close-modal:hover {
            color: var(--navy);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--navy);
            font-size: 0.95em;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            background: var(--white);
            color: var(--navy);
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--navy);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 1em;
            cursor: pointer;
            border: none;
            flex: 1;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--navy);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--navy-light);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--navy);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        /* ========== LOADING ========== */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .loading-spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--navy);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== FULL SCREEN CHAT ========== */
        .full-screen-chat .sidebar {
            display: none;
        }

        .full-screen-chat .chat-area {
            width: 100%;
        }

        /* ========== MOBILE RESPONSIVE ========== */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }
            
            .full-screen-chat .sidebar {
                display: none;
            }
            
            .full-screen-chat .chat-area {
                width: 100%;
            }
            
            .portal-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 15px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
            }
            
            .message {
                max-width: 85%;
            }
        }

        /* ========== SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Main Portal -->
    <div class="creator-portal">
        <!-- Header -->
        <header class="portal-header">
            <div class="portal-brand">EVERNET SUPPORT</div>
            <div class="header-actions">
                <a href="/dashboard/" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </a>
            </div>
        </header>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <div class="status-text" id="statusText">Checking status...</div>
            </div>
            <div class="gmt-time" id="gmtTime">--:-- GMT</div>
        </div>

        <!-- Main Content -->
        <div class="portal-content" id="portalContent">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">My Support Tickets</div>
                    <button class="new-ticket-btn" onclick="openNewTicketModal()">
                        <i class="fas fa-plus"></i> New Ticket
                    </button>
                </div>
                <div class="tickets-list" id="ticketsList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Loading tickets...</div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-title" id="chatTitle">Select a ticket</div>
                    <div class="chat-subtitle" id="chatSubtitle">Support hours: 9am-5pm GMT</div>
                    
                    <!-- Action buttons for full-screen mode -->
                    <div class="chat-header-actions">
                        <button class="back-to-tickets-btn" onclick="showTicketList()">
                            <i class="fas fa-list"></i>
                            Show All Tickets
                        </button>
                        <button class="new-ticket-chat-btn" onclick="openNewTicketModal()">
                            <i class="fas fa-plus"></i>
                            Create New Ticket
                        </button>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="loading">
                        <i class="fas fa-comments" style="font-size: 3em; margin-bottom: 15px; opacity: 0.2; color: var(--navy);"></i>
                        <div style="color: var(--navy);">Select a ticket to view conversation</div>
                    </div>
                </div>

                <!-- Chat Input Area (shown for open tickets) -->
                <div class="chat-input-area" id="chatInputArea" style="display: none;">
                    <div class="auto-response-notice" id="autoResponseNotice" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        <span>Support is currently offline. You'll receive an auto-response and support will reply during work hours.</span>
                    </div>
                    <div class="input-container">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Type your message here..." 
                            oninput="handleTyping()"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>

                <!-- Closed Ticket View (shown when ticket is closed) -->
                <div class="closed-ticket-view" id="closedTicketView" style="display: none;">
                    <div class="closed-ticket-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <div class="closed-ticket-message">
                        This ticket has been closed by support.
                    </div>
                    <button class="closed-ticket-btn" onclick="openNewTicketModal()">
                        <i class="fas fa-plus"></i>
                        Create New Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Ticket Modal -->
    <div class="modal-overlay" id="newTicketModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create New Ticket</h3>
                <button class="close-modal" onclick="closeModal('newTicketModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="form-group">
                <label class="form-label">Subject</label>
                <input type="text" class="form-input" id="ticketSubject" placeholder="What do you need help with?">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="ticketMessage" placeholder="Please describe your issue in detail..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('newTicketModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewTicket()">
                    <i class="fas fa-plus"></i> Create Ticket
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAuSEqhLenwrEz-qrIn1drjAugy1YSkDlI",
            authDomain: "creators-portal-428c5.firebaseapp.com",
            projectId: "creators-portal-428c5",
            storageBucket: "creators-portal-428c5.firebasestorage.app",
            messagingSenderId: "499280036303",
            appId: "1:499280036303:web:b4d80d3b7fe1291381d2ba",
            measurementId: "G-CYWGD80FS5"
        };

        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (error) {
            app = firebase.app();
            auth = firebase.auth();
            db = firebase.firestore();
        }
    </script>

    <!-- Main Script -->
    <script>
        let currentUser = null;
        let currentTicketId = null;
        let messagesListener = null;
        let supportSettings = null;
        let isSupportOnline = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await checkAuthState();
                await loadSupportSettings();
                updateGMTTime();
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // Auth
        async function checkAuthState() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserTickets();
                        resolve();
                    } else {
                        window.location.href = 'index.html';
                    }
                });
            });
        }

        // Support Settings
        async function loadSupportSettings() {
            try {
                const settingsRef = db.collection('support_settings').doc('configuration');
                const settingsDoc = await settingsRef.get();
                
                if (settingsDoc.exists) {
                    supportSettings = settingsDoc.data();
                } else {
                    supportSettings = {
                        workHoursStart: 9,
                        workHoursEnd: 17,
                        weekendDays: [0, 6],
                        afterHoursResponse: "Thank you for reaching out to EverNet Support! Our support team will begin reviewing your message at 9am GMT. In the meantime, feel free to add any additional details to your message.",
                        weekendResponse: "Thank you for reaching out to EverNet Support! Our team is currently offline for the weekend and will be back on Monday at 9am GMT."
                    };
                }
                
                updateSupportStatus();
                setInterval(updateSupportStatus, 60000);
                
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // FIXED: Time check function
        function updateSupportStatus() {
            const now = new Date();
            const gmtHour = now.getUTCHours(); // UTC hour (GMT)
            const gmtDay = now.getUTCDay(); // UTC day (0 = Sunday)
            
            console.log('Current GMT time:', {
                hour: gmtHour,
                day: gmtDay,
                dayName: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][gmtDay]
            });
            
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const autoResponseNotice = document.getElementById('autoResponseNotice');
            
            const isWeekend = supportSettings.weekendDays.includes(gmtDay);
            const isWorkHours = gmtHour >= supportSettings.workHoursStart && 
                               gmtHour < supportSettings.workHoursEnd;
            
            if (isWeekend) {
                statusDot.className = 'status-dot';
                statusText.textContent = 'Support Offline - Weekend';
                statusText.style.color = 'var(--offline)';
                isSupportOnline = false;
                
                if (autoResponseNotice) {
                    autoResponseNotice.style.display = 'flex';
                    autoResponseNotice.innerHTML = `<i class="fas fa-info-circle"></i> <span>${supportSettings.weekendResponse || 'Support is offline for the weekend. Back Monday at 9am GMT.'}</span>`;
                }
            } else if (!isWorkHours) {
                statusDot.className = 'status-dot';
                statusText.textContent = `Support Offline - Back at ${supportSettings.workHoursStart}am GMT`;
                statusText.style.color = 'var(--offline)';
                isSupportOnline = false;
                
                if (autoResponseNotice) {
                    autoResponseNotice.style.display = 'flex';
                    autoResponseNotice.innerHTML = `<i class="fas fa-info-circle"></i> <span>${supportSettings.afterHoursResponse || 'Support is currently offline. Back tomorrow at 9am GMT.'}</span>`;
                }
            } else {
                statusDot.className = 'status-dot online';
                statusText.textContent = `Support Online - ${supportSettings.workHoursStart}am-${supportSettings.workHoursEnd}pm GMT`;
                statusText.style.color = 'var(--online)';
                isSupportOnline = true;
                
                if (autoResponseNotice) {
                    autoResponseNotice.style.display = 'none';
                }
            }
        }

        function updateGMTTime() {
            const now = new Date();
            const gmtTime = now.toUTCString().split(' ')[4];
            document.getElementById('gmtTime').textContent = gmtTime + ' GMT';
            setTimeout(updateGMTTime, 60000);
        }

        // Auto-response system
        async function sendAutoResponse(ticketId) {
            if (isSupportOnline) return; // Only send auto-responses when offline
            
            try {
                const ticketDoc = await db.collection('support_tickets').doc(ticketId).get();
                if (!ticketDoc.exists) return;
                
                const ticket = ticketDoc.data();
                const now = new Date();
                const gmtHour = now.getUTCHours();
                const gmtDay = now.getUTCDay();
                
                let autoResponseMessage = '';
                
                // Check if it's weekend
                if (supportSettings.weekendDays.includes(gmtDay)) {
                    autoResponseMessage = supportSettings.weekendResponse || 
                        "Thank you for reaching out to EverNet Support! Our team is currently offline for the weekend and will be back on Monday at 9am GMT.";
                } else {
                    autoResponseMessage = supportSettings.afterHoursResponse || 
                        "Thank you for reaching out to EverNet Support! Our support team will begin reviewing your message at 9am GMT. In the meantime, feel free to add any additional details to your message.";
                }
                
                // Save auto-response message
                const messageData = {
                    ticketId: ticketId,
                    senderId: 'system',
                    senderType: 'system',
                    senderEmail: 'support@evergreenempireltd.com',
                    senderName: 'Auto-Response System',
                    message: autoResponseMessage,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false,
                    automated: true
                };
                
                await db.collection('support_messages').add(messageData);
                
                console.log('Auto-response sent for ticket:', ticketId);
                
            } catch (error) {
                console.error('Error sending auto-response:', error);
            }
        }

        // Ticket Management
        function selectTicket(ticketId) {
            currentTicketId = ticketId;
            
            // AUTO GO FULL SCREEN WHEN TICKET IS SELECTED
            document.getElementById('portalContent').classList.add('full-screen-chat');
            
            document.querySelectorAll('.ticket-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.ticket-item[onclick*="${ticketId}"]`)?.classList.add('active');
            
            loadTicketChat(ticketId);
        }

        function showTicketList() {
            // Exit full screen mode
            document.getElementById('portalContent').classList.remove('full-screen-chat');
            
            // Hide chat input and closed ticket view
            document.getElementById('chatInputArea').style.display = 'none';
            document.getElementById('closedTicketView').style.display = 'none';
            
            // Reset chat display
            document.getElementById('chatMessages').innerHTML = `
                <div class="loading">
                    <i class="fas fa-comments" style="font-size: 3em; margin-bottom: 15px; opacity: 0.2; color: var(--navy);"></i>
                    <div style="color: var(--navy);">Select a ticket to view conversation</div>
                </div>
            `;
        }

        async function loadUserTickets() {
            try {
                const ticketsList = document.getElementById('ticketsList');
                ticketsList.innerHTML = `<div class="loading"><div class="loading-spinner"></div><div>Loading...</div></div>`;
                
                const allTicketsSnapshot = await db.collection('support_tickets').get();
                
                if (allTicketsSnapshot.empty) {
                    ticketsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--navy);">
                            <i class="fas fa-inbox" style="font-size: 2em; margin-bottom: 10px; opacity: 0.2;"></i>
                            <div>No support tickets yet</div>
                            <button class="new-ticket-btn" onclick="openNewTicketModal()" style="margin-top: 20px;">
                                <i class="fas fa-plus"></i> Create First Ticket
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const userTickets = [];
                allTicketsSnapshot.forEach(doc => {
                    const ticket = doc.data();
                    const ticketId = doc.id;
                    
                    if (ticket.creatorId === currentUser.uid || 
                        ticket.creatorEmail === currentUser.email) {
                        userTickets.push({ id: ticketId, ...ticket });
                    }
                });
                
                if (userTickets.length === 0) {
                    ticketsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--navy);">
                            <i class="fas fa-inbox" style="font-size: 2em; margin-bottom: 10px; opacity: 0.2;"></i>
                            <div>No support tickets yet</div>
                            <button class="new-ticket-btn" onclick="openNewTicketModal()" style="margin-top: 20px;">
                                <i class="fas fa-plus"></i> Create First Ticket
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Sort by date
                userTickets.sort((a, b) => {
                    const timeA = a.lastMessageAt ? a.lastMessageAt.toDate().getTime() : 0;
                    const timeB = b.lastMessageAt ? b.lastMessageAt.toDate().getTime() : 0;
                    return timeB - timeA;
                });
                
                let html = '';
                
                for (const ticketData of userTickets) {
                    const ticket = ticketData;
                    const ticketId = ticketData.id;
                    
                    const unreadQuery = await db.collection('support_messages')
                        .where('ticketId', '==', ticketId)
                        .where('senderType', '==', 'support')
                        .where('read', '==', false)
                        .get();
                    
                    const hasUnread = !unreadQuery.empty;
                    const safeTicketId = ticketId.replace(/'/g, "\\'");
                    
                    html += `
                        <div class="ticket-item ${currentTicketId === ticketId ? 'active' : ''}" 
                             onclick="selectTicket('${safeTicketId}')">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div class="ticket-id">#${ticketId.substring(0, 8)}</div>
                                ${hasUnread ? '<div class="unread-badge"></div>' : ''}
                            </div>
                            <div class="ticket-subject">${ticket.subject || 'No subject'}</div>
                            <div class="ticket-meta">
                                <span>${ticket.createdAt ? formatDate(ticket.createdAt.toDate()) : ''}</span>
                                <span class="ticket-status status-${ticket.status || 'open'}">
                                    ${ticket.status || 'Open'}
                                </span>
                            </div>
                        </div>
                    `;
                }
                
                ticketsList.innerHTML = html;
                
                if (!currentTicketId && userTickets.length > 0) {
                    selectTicket(userTickets[0].id);
                }
                
            } catch (error) {
                console.error('Error loading tickets:', error);
                ticketsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--navy);">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>Unable to load tickets</div>
                        <button class="new-ticket-btn" onclick="openNewTicketModal()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Create New Ticket
                        </button>
                    </div>
                `;
            }
        }

        async function loadTicketChat(ticketId) {
            try {
                const ticketDoc = await db.collection('support_tickets').doc(ticketId).get();
                
                if (!ticketDoc.exists) {
                    return;
                }
                
                const ticket = ticketDoc.data();
                
                document.getElementById('chatTitle').textContent = ticket.subject || 'No subject';
                document.getElementById('chatSubtitle').textContent = 
                    `Created: ${ticket.createdAt ? formatDate(ticket.createdAt.toDate()) : ''} | Status: ${ticket.status || 'Open'}`;
                
                loadTicketMessages(ticketId);
                markMessagesAsRead(ticketId);
                
                // Check if ticket is closed
                if (ticket.status === 'closed' || ticket.status === 'resolved') {
                    // Show closed ticket view, hide chat input
                    document.getElementById('chatInputArea').style.display = 'none';
                    document.getElementById('closedTicketView').style.display = 'block';
                } else {
                    // Show chat input for open tickets
                    document.getElementById('chatInputArea').style.display = 'block';
                    document.getElementById('closedTicketView').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        async function loadTicketMessages(ticketId) {
            try {
                if (messagesListener) {
                    messagesListener();
                }
                
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `<div class="loading"><div class="loading-spinner"></div><div>Loading messages...</div></div>`;
                
                messagesListener = db.collection('support_messages')
                    .where('ticketId', '==', ticketId)
                    .orderBy('timestamp', 'asc')
                    .onSnapshot((snapshot) => {
                        if (snapshot.empty) {
                            chatMessages.innerHTML = `
                                <div style="text-align: center; padding: 40px; color: var(--navy);">
                                    <i class="fas fa-comments" style="font-size: 2em; margin-bottom: 10px; opacity: 0.2;"></i>
                                    <div>No messages yet. Start the conversation!</div>
                                </div>
                            `;
                            return;
                        }
                        
                        let html = '';
                        snapshot.forEach(doc => {
                            const message = doc.data();
                            const time = message.timestamp ? message.timestamp.toDate() : new Date();
                            let messageClass = 'creator';
                            let senderName = 'You';
                            
                            if (message.senderType === 'support') {
                                messageClass = 'support';
                                senderName = 'Evernet Support';
                            } else if (message.senderType === 'system') {
                                messageClass = 'system';
                                senderName = 'Auto-Response';
                            }
                            
                            html += `
                                <div class="message ${messageClass}">
                                    <div class="message-header">
                                        <span><strong>${senderName}</strong></span>
                                        <span>${time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                    <div class="message-content">${message.message || ''}</div>
                                    <div class="message-time">
                                        ${time.toLocaleDateString()}
                                    </div>
                                </div>
                            `;
                        });
                        
                        chatMessages.innerHTML = html;
                        
                        setTimeout(() => {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }, 100);
                        
                    }, (error) => {
                        console.error('Error loading messages:', error);
                    });
                
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        async function markMessagesAsRead(ticketId) {
            try {
                const unreadQuery = await db.collection('support_messages')
                    .where('ticketId', '==', ticketId)
                    .where('senderType', '==', 'support')
                    .where('read', '==', false)
                    .get();
                
                const batch = db.batch();
                unreadQuery.forEach(doc => {
                    batch.update(doc.ref, { read: true });
                });
                
                if (!unreadQuery.empty) {
                    await batch.commit();
                }
                
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        // Messaging
        function handleTyping() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            
            if (chatInput.value.trim() !== '') {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = true;
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message || !currentTicketId) {
                return;
            }
            
            try {
                const messageData = {
                    ticketId: currentTicketId,
                    senderId: currentUser.uid,
                    senderType: 'creator',
                    senderEmail: currentUser.email,
                    senderName: currentUser.displayName || currentUser.email.split('@')[0],
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                };
                
                await db.collection('support_messages').add(messageData);
                
                await db.collection('support_tickets').doc(currentTicketId).update({
                    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'open',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                chatInput.value = '';
                document.getElementById('sendBtn').disabled = true;
                
                // Send auto-response if support is offline
                if (!isSupportOnline) {
                    setTimeout(() => {
                        sendAutoResponse(currentTicketId);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // New Ticket
        async function createNewTicket() {
            const subject = document.getElementById('ticketSubject').value.trim();
            const message = document.getElementById('ticketMessage').value.trim();
            
            if (!subject || !message) {
                alert('Please fill all fields');
                return;
            }
            
            try {
                const ticketData = {
                    creatorId: currentUser.uid,
                    creatorEmail: currentUser.email,
                    creatorName: currentUser.displayName || currentUser.email.split('@')[0],
                    subject: subject,
                    description: message,
                    status: 'open',
                    priority: 'medium',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const ticketRef = await db.collection('support_tickets').add(ticketData);
                
                const messageData = {
                    ticketId: ticketRef.id,
                    senderId: currentUser.uid,
                    senderType: 'creator',
                    senderEmail: currentUser.email,
                    senderName: currentUser.displayName || currentUser.email.split('@')[0],
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                };
                
                await db.collection('support_messages').add(messageData);
                
                closeModal('newTicketModal');
                document.getElementById('ticketSubject').value = '';
                document.getElementById('ticketMessage').value = '';
                
                // Send auto-response immediately if support is offline
                if (!isSupportOnline) {
                    setTimeout(() => {
                        sendAutoResponse(ticketRef.id);
                    }, 1000);
                }
                
                selectTicket(ticketRef.id);
                
            } catch (error) {
                console.error('Error creating ticket:', error);
                alert('Failed to create ticket');
            }
        }

        // Modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openNewTicketModal() {
            openModal('newTicketModal');
        }

        // Utility
        function formatDate(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
    </script>
</body>
</html> 